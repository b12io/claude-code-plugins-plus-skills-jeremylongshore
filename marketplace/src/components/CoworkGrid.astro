---
import coworkPacks from '../data/cowork-packs.json';

interface Props {
  featured?: boolean;
  limit?: number;
}

const { featured = false, limit } = Astro.props;

let displayPacks = coworkPacks.packs;
if (featured) {
  displayPacks = displayPacks.filter(p => p.featured);
}
if (limit) {
  displayPacks = displayPacks.slice(0, limit);
}

// Try to load enriched manifest data (generated at build time)
let manifest: any = null;
try {
  manifest = (await import('../data/cowork-manifest.json')).default;
} catch {
  // Manifest not yet generated - will show packs without sizes
}

// Map bundle data by category for enrichment
const bundleMap = new Map();
if (manifest?.bundles) {
  for (const b of manifest.bundles) {
    bundleMap.set(b.category, b);
  }
}

// SVG icon map (inline SVGs for zero-dependency rendering)
const icons: Record<string, string> = {
  'brain': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 0-7 7c0 3 2 5.5 4 7.5S12 22 12 22s3-3.5 3-5.5 4-4.5 4-7.5a7 7 0 0 0-7-7z"/></svg>',
  'rocket': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 00-2.91-.09z"/><path d="M12 15l-3-3a22 22 0 012-3.95A12.88 12.88 0 0122 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 01-4 2z"/></svg>',
  'package': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
  'shield': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>',
  'database': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>',
  'check-circle': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
  'link': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>',
  'globe': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/></svg>',
  'zap': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
  'star': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
  'bot': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="5" r="2"/><path d="M12 7v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/></svg>',
  'trending-up': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>',
  'users': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>',
  'briefcase': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg>',
  'dollar-sign': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>',
  'settings': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>',
  'book-open': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 014 4v14a3 3 0 00-3-3H2z"/><path d="M22 3h-6a4 4 0 00-4 4v14a3 3 0 013-3h7z"/></svg>',
  'box': '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>',
};
---

<style>
  .cowork-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .cowork-card {
    background: white;
    border: 2px solid var(--brand-light-gray, #e5e7eb);
    border-radius: 12px;
    padding: 1.5rem;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .cowork-card:hover {
    border-color: var(--brand-orange, #d97757);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
  }

  .cowork-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .cowork-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    flex-shrink: 0;
  }

  .cowork-icon :global(svg) {
    width: 22px;
    height: 22px;
  }

  .cowork-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
    font-family: 'Poppins', Arial, sans-serif;
  }

  .cowork-description {
    color: var(--brand-mid-gray, #6b7280);
    font-size: 0.9rem;
    line-height: 1.5;
    margin: 0;
    flex: 1;
  }

  .cowork-stats {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .cowork-stat {
    background: var(--brand-light, #f8f9fa);
    padding: 0.2rem 0.6rem;
    border-radius: 20px;
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--brand-mid-gray, #6b7280);
  }

  .cowork-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid var(--brand-light-gray, #e5e7eb);
    margin-top: auto;
  }

  .download-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    background: var(--brand-orange, #f97316);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s, transform 0.1s;
    font-family: 'Poppins', Arial, sans-serif;
  }

  .download-btn:hover {
    background: var(--brand-orange-dark, #ea580c);
    transform: scale(1.02);
  }

  .download-btn:active {
    transform: scale(0.98);
  }

  .download-size {
    font-size: 0.75rem;
    opacity: 0.85;
  }

  @media (max-width: 768px) {
    .cowork-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="cowork-grid">
  {displayPacks.map(pack => {
    const bundle = bundleMap.get(pack.category);
    const iconSvg = icons[pack.icon] || icons['package'];
    return (
      <div class="cowork-card" data-pack-id={pack.id}>
        <div class="cowork-header">
          <span class="cowork-icon" style={`background: ${pack.color}15; color: ${pack.color};`}>
            <Fragment set:html={iconSvg} />
          </span>
          <h3 class="cowork-title">{pack.name}</h3>
        </div>

        <p class="cowork-description">{pack.description}</p>

        {bundle && (
          <div class="cowork-stats">
            <span class="cowork-stat">{bundle.pluginCount} plugins</span>
            {bundle.totalSkills > 0 && <span class="cowork-stat">{bundle.totalSkills} skills</span>}
          </div>
        )}

        <div class="cowork-footer">
          <span class="cowork-stat">
            {bundle ? bundle.sizeFormatted : 'Loading...'}
          </span>
          <a
            href={bundle ? bundle.path : `/downloads/bundles/${pack.category}.zip`}
            download={`${pack.category}.zip`}
            class="download-btn"
            data-category={pack.category}
          >
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" role="img" aria-hidden="true"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Download
          </a>
        </div>
      </div>
    );
  })}
</div>

<script is:inline>
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.download-btn');
    if (!btn) return;
    const category = btn.dataset.category;
    if (!category) return;

    const toast = document.createElement('div');
    toast.textContent = 'Downloading ' + category + ' pack...';
    toast.style.cssText = 'position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1a1a1a;color:white;padding:1rem 1.5rem;border-radius:8px;font-size:0.9rem;z-index:1000;animation:coworkFade 2.5s ease-in-out;';
    document.body.appendChild(toast);
    setTimeout(function() { toast.remove(); }, 2500);

    if (typeof gtag !== 'undefined') {
      gtag('event', 'download', { event_category: 'cowork', event_label: category });
    }
  });
</script>

<style is:global>
  @keyframes coworkFade {
    0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
    85% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  }
</style>
